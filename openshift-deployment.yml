---
- hosts: all
  vars:
    app_name: vmaas
    apidoc_container_port: 8080
    webapp_container_port: 8080
    reposcan_container_port: 8081
  tasks:
    - name: Prevent run without tags
      fail:
        msg: "You must run this playbook with tags! Available tags: up, routes-up, down, routes-down, update-images."

    - name: Get current project
      command: oc project
      changed_when: False
      register: oc_project_out
      tags:
        - up
        - down
        - update-images
        - routes-up
        - routes-down

    - name: Print current project
      debug:
        msg: "{{ oc_project_out.stdout }}"
      tags:
        - up
        - down
        - update-images
        - routes-up
        - routes-down

    - name: Create VMaaS
      shell: kompose --provider openshift convert -o - | ./scripts/openshift_app_label.py {{ app_name }} | oc create -f -
      tags:
        - up

    - name: Create OpenShift routes
      shell: oc expose service apidoc --port {{ apidoc_container_port }}; oc expose service reposcan --port {{ reposcan_container_port }}; oc expose service webapp --port {{ webapp_container_port }}
      tags:
        - up
        - routes-up

    - name: Update VMaaS images
      shell: for image in $(grep "image:" docker-compose.yml | awk '{print $2}'); do oc import-image $image; done
      tags:
        - update-images

    - name: Delete OpenShift routes
      shell: oc delete route apidoc reposcan webapp
      tags:
        - down
        - routes-down

    - name: Delete VMaaS
      shell: kompose --provider openshift convert -o - | ./scripts/openshift_app_label.py {{ app_name }} | oc delete -f -
      tags:
        - down
